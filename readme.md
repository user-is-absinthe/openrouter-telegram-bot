# OpenRouter Telegram Bot

Телеграм бот для общения с AI моделями через сервис OpenRouter. Позволяет выбирать различные языковые модели, сохранять контекст общения и предоставляет расширенные возможности для администраторов.

## Характеристики

- Выбор из широкого каталога моделей OpenRouter (бесплатные для всех, платные для администраторов)
- Постраничный просмотр и фильтрация моделей (бесплатные, топовые)
- Потоковая генерация ответов с обновлением в реальном времени
- Возможность остановить генерацию ответа в любой момент
- Перезапуск генерации для получения альтернативного ответа
- Поддержка длинных ответов с автоматическим разбиением на части
- Сохранение истории диалогов в SQLite базе данных
- Сохранение контекста диалога и возможность создать новую беседу
- Информирование о заполнении контекста и рекомендации по его обновлению
- Корректное отображение форматированного текста в Telegram
- Расширенные возможности для администраторов (платные модели, управление каталогом)

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/user-is-absinthe/openrouter-telegram-bot.git
   cd openrouter-telegram-bot
   ```

2. Создайте и активируйте виртуальное окружение:
   ```bash
   python -m venv venv
   # Linux/macOS
   source venv/bin/activate
   # Windows
   venv\Scripts\activate
   ```

3. Установите необходимые зависимости:
   ```bash
   pip install python-telegram-bot requests md2tgmd
   ```

4. Создайте и настройте файл `config.py`:
   ```python
   # Токены и ключи API
   TELEGRAM_BOT_TOKEN = "tg_token"
   OPENROUTER_API_KEY = "op_token"
   
   DB_PATH = r"data/openrouter_bot.db"
   
   # Настройки сайта для OpenRouter
   SITE_URL = "https://github.com/user-is-absinthe/openrouter-telegram-bot"
   SITE_NAME = "OpenRouter Telegram Bot"
   
   # Настройки обновления сообщений
   STREAM_UPDATE_INTERVAL = 1.5  # Интервал обновления сообщений в секундах при потоковой передаче
   
   # ID администраторов (список строк)
   ADMIN_IDS = ["YOUR_ADMIN_ID_1", "YOUR_ADMIN_ID_2"]
   ```

5. Запустите бота:
   ```bash
   python openrouterbot.py
   ```

## Использование

1. Отправьте команду `/start` вашему боту в Telegram, чтобы начать взаимодействие.
2. Используйте команду `/select_model` для выбора AI модели из списка (обычные пользователи видят только бесплатные модели).
3. После выбора модели отправьте любое текстовое сообщение, и бот передаст его выбранной модели.
4. Во время генерации ответа вы можете нажать кнопку "Остановить генерацию", чтобы прервать процесс.
5. После получения ответа вы можете нажать кнопку "Перезагрузить ответ", чтобы получить новый ответ на тот же запрос.
6. Используйте команду `/new_dialog` для начала нового диалога (сброса контекста).
7. При заполнении контекста на 90% и более, бот предложит вам начать новый диалог для лучшей работы.
8. Используйте команду `/help` для получения справки по всем доступным командам.

### Дополнительные возможности для администраторов

Для пользователей, чьи ID указаны в списке `ADMIN_IDS` в конфигурационном файле, доступны дополнительные функции:

- Доступ ко всем моделям, включая платные
- Просмотр информации о стоимости использования модели
- Команды для управления списком моделей:
  - `/update_models` - Обновить список моделей из API
  - `/translate_descriptions` - Перевести описания моделей
  - `/translate_all` - Перевести все описания моделей
  - `/set_description` - Установить русское описание модели
  - `/set_top` - Установить или снять статус топ-модели
  - `/list_models` - Показать список моделей в БД

## Структура проекта

- `openrouterbot.py` - основной файл с логикой телеграм-бота
- `db_handler.py` - обработчик для работы с SQLite базой данных
- `config.py` - файл с конфигурационными параметрами
- `data/openrouter_bot.db` - файл базы данных SQLite (создается автоматически)

## Чеклист для будущих улучшений

- [ ] Вывод "мыслей" думающих моделей
- [x] Исправить форматирование markdown для Telegram
- [x] Добавить моделям контекст для продолжения диалога
- [x] Добавить возможность отмечать "топовые" модели (для админов)
- [x] Добавить постраничный вывод и фильтрацию списка моделей
- [x] Добавить поддержку платных моделей для администраторов
- [x] Реализовать уведомления о заполнении контекста
- [ ] Добавить статистику использования моделей
- [ ] Интегрировать работу с изображениями для multimodal-моделей

## База данных

Бот использует SQLite для хранения информации о пользователях, диалогах и моделях. 

### Таблица Users
- id - первичный ключ
- id_chat - ID чата в Telegram
- id_user - ID пользователя в Telegram
- first_name - имя пользователя
- last_name - фамилия пользователя
- username - юзернейм в Telegram
- is_active - активен ли пользователь (1) или заблокировал бота (0)
- created_at - время регистрации пользователя

### Таблица Dialogs
- id - первичный ключ
- id_chat - ID чата в Telegram
- id_user - ID пользователя в Telegram
- number_dialog - порядковый номер диалога для пользователя
- last_message - флаг последнего сообщения в диалоге (1) или нет (0)
- model - название модели для отображения
- model_id - полный ID модели для API запросов
- user_ask - запрос пользователя
- model_answer - ответ модели
- displayed - отображается ли в контексте (1) или нет (0)
- timestamp - время создания записи

### Таблица Models
- id - ID модели для API запросов (первичный ключ)
- name - название модели для отображения
- description - описание модели (английский)
- description_ru - описание модели (русский)
- context_length - максимальная длина контекста в токенах
- prompt_price - стоимость запроса (за 1M токенов)
- completion_price - стоимость ответа (за 1M токенов)
- is_free - бесплатная ли модель (1) или платная (0)
- top_model - отмечена ли как топовая модель (1) или нет (0)

## Лицензия

MIT